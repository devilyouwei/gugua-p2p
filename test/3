import smoke from 'smokesignal'
import root from 'app-root-path'
import { Network, Seed } from './Data'
import through from 'through2'
import DB from '../DB'

export default class SmokeP2P {
    createNode(network: Network) {
        const list = getIp(network)
        console.log('Node List:')
        console.log(list)
        // get user network
        const node = smoke.createNode({
            port: PORT,
            address: smoke.localIp(`${network.ip}/${network.netmask}`),
            seeds: list
        })

        console.log('Port', node.options.port)
        console.log('IP', node.options.address)
        console.log('ID', node.id)

        console.log('Connecting...')

        node.on('connect', e => {
            console.log('connected')
            console.log('Now start to type:')
            node.broadcast.write(JSON.stringify(list))
        })

        process.stdin.pipe(node.broadcast).pipe(stream).pipe(process.stdout)

        node.on('disconnect', () => {
            console.log('disconnect')
        })

        node.on('error', e => {
            console.error(e)
        })

        node.start()
    }
    setSeed(list: Seed[]) {
        if (!list.length) return
        const file = `${root}/store/p2p.db`
        const db = new DB(file)
        for (const item of list) {
        }
    }
    async getSeed(): Seed[] {
        const res = await db.find()
    }
}

//a p2p server list
const json = `${root}/test/p2p.json`
const PORT = 6666
const stream = through(write)

function write(line, _, next) {
    // write ip list to local file
    const obj = $.parse(line.toString())
    // if object, it is ip list, set to file
    if (typeof obj == 'object') setIp(obj)
    // push to stdout in console
    else this.push(line)
    next()
}
// get ip list and transform to smoke signal required data struct
function getIp(my: Network): Seed[] {
    list[my.ip] = PORT
    const list = $.parse(fs.readFileSync(json, 'utf-8')) as Map<string, number>
    const arr: Seed[] = []
    for (const i in list) {
        arr.push({
            address: i,
            port: list[i]
        })
    }
    return arr
}
// save ip list to local file, cover
function setIp(list: Seed[]) {
    if (!list.length) return
    const hash = $.parse(fs.readFileSync(json, 'utf-8')) as Map<string, number>
    for (const item of list) hash[item.address] = item.port
    const ipText = $.stringify(hash)
    fs.writeFileSync(json, ipText)
}
